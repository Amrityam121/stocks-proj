<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Stock Price Tracker</title>
    <meta name="description" content="Professional NSE stock price tracker with search, favorites, and auto-refresh." />
    <style>
        :root{
            --bg-1:#f4f7fb;
            --card:#ffffff;
            --muted:#6b7280;
            --accent:#3b82f6;
            --accent-2:#7c3aed;
            --success:#10b981;
            --danger:#ef4444;
            --glass: rgba(255,255,255,0.8);
            --radius:12px;
            --shadow: 0 8px 30px rgba(2,6,23,0.08);
        }
        html[data-theme="dark"]{
            --bg-1: linear-gradient(180deg,#061028,#081226);
            --card:#071126;
            --muted:#9ca3af;
            --accent:#60a5fa;
            --accent-2:#a78bfa;
            --success:#34d399;
            --danger:#f87171;
            --glass: rgba(255,255,255,0.04);
            --shadow: 0 8px 40px rgba(2,6,23,0.6);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            margin:0;
            background: linear-gradient(180deg,var(--bg-1),#eef2ff 60%);
            color:var(--muted);
            display:flex;
            align-items:center;
            justify-content:center;
            padding:28px;
        }
        .container{width:100%;max-width:980px;background:var(--card);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;display:grid;grid-template-columns:1fr 360px;gap:0;transition:background-color 220ms,color 220ms,box-shadow 220ms}
        header{padding:28px 32px;border-bottom:1px solid #f1f5f9;background:linear-gradient(90deg, rgba(59,130,246,0.04), rgba(124,58,237,0.02));}
        .title{display:flex;gap:16px;align-items:center}
        .title h1{font-size:20px;margin:0}
        .title p{margin:0;font-size:13px;color:var(--muted)}
        .main{padding:28px 32px}
        .sidebar{background:#fbfbff;padding:20px;border-left:1px solid #f1f5f9}

        /* Search */
        .search-wrap{display:flex;gap:12px;align-items:center}
        #stockInput{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e6eef8;font-size:15px}
        .controls{display:flex;gap:8px}
        .btn{background:var(--accent);color:white;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;box-shadow:0 6px 18px rgba(59,130,246,0.12);transition:transform .14s ease,box-shadow .14s ease}
        .btn:hover{transform:translateY(-3px)}
        .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(230,238,248,0.6);backdrop-filter: blur(6px)}

        /* Suggestions */
        .suggestions{position:relative}
        .suggestions-list{position:absolute;left:0;right:0;top:44px;background:var(--card);border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.08);max-height:320px;overflow:auto;border:1px solid rgba(0,0,0,0.04);display:none}
        .suggestions-list.active{display:block}
        .suggestion-item{display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,0.04);cursor:pointer}
        .suggestion-item:last-child{border-bottom:none}
        .suggestion-symbol{font-weight:600}
        .suggestion-name{color:var(--muted);font-size:13px}
        .suggestion-item.selected{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}

        /* Results card */
        .results{margin-top:18px}
        .stock-card{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:white;padding:18px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 10px 30px rgba(99,102,241,0.12)}
        .stock-info{display:flex;gap:12px;align-items:center}
        .stock-symbol{font-size:20px;font-weight:700;letter-spacing:1px}
        .stock-meta{color:rgba(255,255,255,0.85);font-size:13px}
        .stock-price{font-size:32px;font-weight:700}
        .price-trend{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.08)}
        .trend-up{color:var(--success)}
        .trend-down{color:var(--danger)}

        /* Sidebar lists */
        .list{margin-bottom:18px}
        .list h3{margin:0 0 8px 0;font-size:13px;color:var(--muted)}
        .stock-quick-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.9));border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
        .stock-quick-item:hover{transform:translateY(-4px);box-shadow:0 8px 22px rgba(2,6,23,0.06)}
        .favorite{background:transparent;border:none;cursor:pointer;font-size:16px;color:var(--muted)}

        /* Portfolio builder */
        .portfolio{margin-top:22px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));padding:14px;border-radius:12px}
        .portfolio-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .portfolio-rows{display:flex;flex-direction:column;gap:8px}
        .portfolio-row{display:grid;grid-template-columns: 1fr 120px 140px 56px;gap:8px;align-items:center;padding:10px;border-radius:10px;background:var(--card);border:1px solid rgba(0,0,0,0.04)}
        .portfolio-row input[type="text"], .portfolio-row input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
        .portfolio-row .price{font-weight:600}
        .portfolio-row .row-remove{background:transparent;border:none;color:var(--danger);font-size:18px;cursor:pointer}
        .portfolio-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
        .total-value{font-weight:700;font-size:18px}

        /* Footer controls */
        .small{font-size:13px;color:var(--muted)}
        button#themeToggle{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.04);cursor:pointer}

        /* Dark-theme tweaks for better contrast */
        html[data-theme="dark"] .small{color:#9aa4b2}
        html[data-theme="dark"] .stock-quick-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
        .error{padding:10px;border-radius:8px;background:#fff1f0;color:var(--danger);margin-top:12px}

        @media (max-width:900px){.container{grid-template-columns:1fr}.sidebar{order:2}.main{order:1}}
    </style>
</head>
<body>
    <div class="container" role="application">
        <div style="grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:18px 28px 0 28px;">
            <div class="title">
                <div style="font-size:22px">ðŸ“ˆ Stock Price Tracker</div>
                <div style="margin-left:8px"><p class="small">Search NSE tickers, favorite them, and enable auto-refresh.</p></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
                <label class="small" for="autoRefresh">Auto-refresh</label>
                <input id="autoRefresh" type="checkbox" title="Toggle auto refresh" aria-label="Auto refresh prices">
                <button id="themeToggle" class="btn ghost" title="Toggle theme" aria-label="Toggle theme">ðŸŒ™</button>
            </div>
        </div>

        <main class="main">
            <div class="search-wrap" aria-hidden="false">
                <div style="flex:1;position:relative">
                    <input id="stockInput" type="text" placeholder="Type stock name or symbol (RELIANCE, TCS)" aria-label="Search stock" autocomplete="off">
                    <div class="suggestions">
                        <div id="suggestions" class="suggestions-list" role="listbox" aria-label="Search suggestions"></div>
                    </div>
                </div>
                <div class="controls">
                    <button id="searchBtn" class="btn">Search</button>
                    <button id="clearBtn" class="btn ghost">Clear</button>
                </div>
            </div>

            <div id="loading" style="display:none;margin-top:12px">Loading latest priceâ€¦</div>
            <div id="errorMessage" class="error" style="display:none"></div>

            <div id="results" class="results" style="display:none">
                <div class="stock-card" id="stockCard">
                    <div class="stock-info">
                        <div>
                            <div id="stockSymbol" class="stock-symbol">--</div>
                            <div id="stockMeta" class="stock-meta">NSE â€¢ Last updated: --</div>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div id="stockPrice" class="stock-price">â‚¹--</div>
                        <div id="priceTrend" class="price-trend">--</div>
                    </div>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px">
                    <button id="favToggle" class="btn ghost">â˜† Favorite</button>
                    <button id="refreshBtn" class="btn">âŸ³ Refresh</button>
                </div>
            </div>

                <!-- Portfolio builder -->
                <div class="portfolio" id="portfolio">
                    <div class="portfolio-header">
                        <div style="font-weight:700">Portfolio Builder</div>
                        <div style="display:flex;gap:8px">
                            <button id="addRowBtn" class="btn ghost">+ Add Row</button>
                            <button id="clearPortfolioBtn" class="btn ghost">Clear</button>
                        </div>
                    </div>

                    <div id="portfolioRows" class="portfolio-rows" aria-live="polite"></div>

                    <div class="portfolio-footer">
                        <div class="small">Enter number of shares to compute total per row.</div>
                        <div class="total-value">Total: â‚¹<span id="portfolioTotal">0.00</span></div>
                    </div>
                </div>
        </main>

        <aside class="sidebar" aria-label="Sidebar">
            <div class="list">
                <h3>Popular NSE Stocks</h3>
                <div id="popularStocks"></div>
            </div>

            <div class="list">
                <h3>Favorites</h3>
                <div id="favorites"></div>
            </div>

            <div class="list">
                <h3>Quick Tips</h3>
                <div class="small">Use arrow keys to navigate suggestions. Press Enter to fetch. Toggle auto-refresh to poll prices.</div>
            </div>
        </aside>
    </div>

    <script>
        // Config
        const API_BASE_URL = 'http://localhost:8000';
        const DEBOUNCE_MS = 240;
        const AUTO_REFRESH_INTERVAL = 15_000; // 15s

        // Elements
        const input = document.getElementById('stockInput');
        const suggestionsList = document.getElementById('suggestions');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('errorMessage');
        const results = document.getElementById('results');
        const stockSymbolEl = document.getElementById('stockSymbol');
        const stockMetaEl = document.getElementById('stockMeta');
        const stockPriceEl = document.getElementById('stockPrice');
        const priceTrendEl = document.getElementById('priceTrend');
        const popularEl = document.getElementById('popularStocks');
        const favoritesEl = document.getElementById('favorites');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const favToggle = document.getElementById('favToggle');
        const refreshBtn = document.getElementById('refreshBtn');
        const themeToggle = document.getElementById('themeToggle');
        const autoRefreshCheckbox = document.getElementById('autoRefresh');

        // State
        let suggestions = [];
        let selectedIndex = -1;
        let lastPrice = null;
        let currentSymbol = null;
        let debounceTimer = null;
        let pollTimer = null;

        // Utilities
        function showLoading(){ loadingEl.style.display = 'block'; }
        function hideLoading(){ loadingEl.style.display = 'none'; }
        function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; }
        function clearError(){ errorEl.style.display = 'none'; }

        function saveFavorites(list){ localStorage.setItem('fav_stocks', JSON.stringify(list)); }
        function loadFavorites(){ try{ return JSON.parse(localStorage.getItem('fav_stocks')||'[]'); }catch(e){return []} }

        // Theme handling
        function applyTheme(theme){
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
        }
        // initialize theme from storage or system preference
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        themeToggle.addEventListener('click', ()=>{
            const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        });

        // Debounced search
        input.addEventListener('input', (e)=>{
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(()=>{
                const q = e.target.value.trim();
                if(q) fetchSuggestions(q);
                else closeSuggestions();
            }, DEBOUNCE_MS);
        });

        input.addEventListener('keydown', (e)=>{
            const max = suggestions.length - 1;
            if(e.key === 'ArrowDown'){ e.preventDefault(); selectedIndex = Math.min(selectedIndex+1, max); updateSuggestionHighlight(); }
            else if(e.key === 'ArrowUp'){ e.preventDefault(); selectedIndex = Math.max(selectedIndex-1, 0); updateSuggestionHighlight(); }
            else if(e.key === 'Enter'){ e.preventDefault(); if(selectedIndex>=0) chooseSuggestion(selectedIndex); else if(input.value.trim()) fetchStockPrice(input.value.trim()); }
            else if(e.key === 'Escape'){ closeSuggestions(); }
        });

        document.addEventListener('click', (ev)=>{ if(!ev.target.closest('.suggestions') && ev.target !== input) closeSuggestions(); });

        // Suggestion UI
        function renderSuggestions(){
            suggestionsList.innerHTML = '';
            if(!suggestions.length){ closeSuggestions(); return; }
            suggestions.forEach((s, idx)=>{
                const div = document.createElement('div');
                div.className = 'suggestion-item' + (idx===selectedIndex? ' selected':'');
                div.role = 'option';
                div.innerHTML = `<div><div class="suggestion-symbol">${s.symbol}</div><div class="suggestion-name">${s.name}</div></div>`;
                div.addEventListener('click', ()=> chooseSuggestion(idx));
                div.addEventListener('mouseenter', ()=>{ selectedIndex = idx; updateSuggestionHighlight(); });
                suggestionsList.appendChild(div);
            });
            suggestionsList.classList.add('active');
        }
        function updateSuggestionHighlight(){
            const nodes = suggestionsList.querySelectorAll('.suggestion-item');
            nodes.forEach((n,i)=> n.classList.toggle('selected', i===selectedIndex));
        }
        function closeSuggestions(){ suggestions = []; selectedIndex = -1; suggestionsList.classList.remove('active'); suggestionsList.innerHTML = ''; }

        async function fetchSuggestions(q){
            try{
                const res = await fetch(`${API_BASE_URL}/stocks/search?query=${encodeURIComponent(q)}`);
                if(!res.ok) return;
                const data = await res.json();
                suggestions = data.stocks || [];
                selectedIndex = 0;
                renderSuggestions();
            }catch(e){ console.error('suggestions err',e); }
        }

        function chooseSuggestion(idx){ const s = suggestions[idx]; if(!s) return; input.value = s.symbol; closeSuggestions(); fetchStockPrice(s.symbol); }

        // Fetch price and show
        async function fetchPrice(symbol){
            try{
                const res = await fetch(`${API_BASE_URL}/price/${symbol}:NSE`);
                if(!res.ok) return null;
                const data = await res.json();
                return data.price ?? null;
            }catch(e){ console.error('fetchPrice err', e); return null; }
        }

        async function fetchStockPrice(symbol){
            clearError(); showLoading();
            try{
                const price = await fetchPrice(symbol);
                hideLoading();
                if(price === null){ showError('Price not available for ' + symbol); return; }
                displayStock(symbol, price);
                // update any portfolio rows that match this symbol
                updateRowsForSymbol(symbol.replace(':NSE',''), price);
            }catch(err){ hideLoading(); showError('Unable to fetch price â€” make sure API is running at ' + API_BASE_URL); console.error(err); }
        }

        // Update any portfolio rows that match the fetched symbol
        function updateRowsForSymbol(sym, price){
            const rows = document.querySelectorAll('.portfolio-row');
            rows.forEach(row=>{
                const sInput = row.querySelector('.row-symbol');
                if(!sInput) return;
                if(sInput.value === sym || sInput.value === sym + ':NSE'){
                    row._price = price;
                    const priceEl = row.querySelector('.row-price');
                    if(priceEl) priceEl.textContent = `â‚¹${price.toFixed(2)}`;
                    updateRowTotal(row);
                }
            });
            updatePortfolioTotals();
        }

        // Portfolio row management
        const portfolioRowsEl = document.getElementById('portfolioRows');
        const addRowBtn = document.getElementById('addRowBtn');
        const clearPortfolioBtn = document.getElementById('clearPortfolioBtn');
        const portfolioTotalEl = document.getElementById('portfolioTotal');

        function createRowElement(initialSymbol = ''){
            const row = document.createElement('div');
            row.className = 'portfolio-row';
            row._price = 0;
            row.innerHTML = `
                <div style="position:relative">
                    <input class="row-symbol" type="text" placeholder="Symbol (e.g. TCS)" value="${initialSymbol}" />
                    <div class="row-suggestions" style="position:absolute;left:0;right:0;top:42px;z-index:20;display:none;background:var(--card);border-radius:8px;box-shadow:0 8px 18px rgba(2,6,23,0.06);max-height:200px;overflow:auto"></div>
                </div>
                <div class="price row-price">â‚¹0.00</div>
                <div><input class="row-qty" type="number" min="0" step="1" value="0" /></div>
                <div style="display:flex;justify-content:center"><button class="row-remove" title="Remove row">âœ•</button></div>
            `;

            const symInput = row.querySelector('.row-symbol');
            const sugBox = row.querySelector('.row-suggestions');
            const qtyInput = row.querySelector('.row-qty');
            const removeBtn = row.querySelector('.row-remove');

            // per-row debounce
            let rowDeb = null;
            symInput.addEventListener('input', (e)=>{
                clearTimeout(rowDeb);
                rowDeb = setTimeout(()=>{
                    const q = e.target.value.trim();
                    if(!q){ sugBox.style.display='none'; return; }
                    fetch(`${API_BASE_URL}/stocks/search?query=${encodeURIComponent(q)}`)
                        .then(r=> r.ok? r.json(): null)
                        .then(data=>{
                            const list = (data && data.stocks) || [];
                            renderRowSuggestions(list, sugBox, row);
                        }).catch(()=>{});
                }, 220);
            });

            symInput.addEventListener('blur', ()=>{ setTimeout(()=>{ sugBox.style.display='none'; }, 180); });

            qtyInput.addEventListener('input', ()=>{ updateRowTotal(row); updatePortfolioTotals(); });

            removeBtn.addEventListener('click', ()=>{ row.remove(); updatePortfolioTotals(); });

            return row;
        }

        function renderRowSuggestions(list, box, row){
            box.innerHTML = '';
            if(!list.length){ box.style.display='none'; return; }
            list.forEach(item=>{
                const div = document.createElement('div');
                div.style.padding='8px 10px';
                div.style.cursor='pointer';
                div.textContent = `${item.symbol} â€” ${item.name}`;
                div.addEventListener('click', ()=>{
                    const symInput = row.querySelector('.row-symbol');
                    symInput.value = item.symbol;
                    box.style.display='none';
                    // fetch price for this row's symbol
                    fetchPrice(item.symbol).then(price=>{
                        row._price = price || 0;
                        const priceEl = row.querySelector('.row-price');
                        priceEl.textContent = price ? `â‚¹${price.toFixed(2)}` : 'N/A';
                        updateRowTotal(row);
                        updatePortfolioTotals();
                    });
                });
                box.appendChild(div);
            });
            box.style.display = list.length? 'block':'none';
        }

        function updateRowTotal(row){
            const qty = parseFloat(row.querySelector('.row-qty').value || 0);
            const price = parseFloat(row._price || 0);
            const tot = (qty * price) || 0;
            // show in price column as well as dataset
            const priceEl = row.querySelector('.row-price');
            if(priceEl) priceEl.textContent = price ? `â‚¹${price.toFixed(2)}` : 'â‚¹0.00';
            row._total = tot;
            row.style.opacity = qty>0? '1':'0.95';
        }

        function updatePortfolioTotals(){
            const rows = document.querySelectorAll('.portfolio-row');
            let sum = 0;
            rows.forEach(r=> sum += (r._total || 0));
            portfolioTotalEl.textContent = sum.toFixed(2);
        }

        addRowBtn.addEventListener('click', ()=>{ const r = createRowElement(); portfolioRowsEl.appendChild(r); });
        clearPortfolioBtn.addEventListener('click', ()=>{ portfolioRowsEl.innerHTML=''; updatePortfolioTotals(); });

        // ensure at least one row exists
        (function ensureRow(){ if(!portfolioRowsEl.children.length) addRowBtn.click(); })();

        function displayStock(symbol, price){
            currentSymbol = symbol.replace(':NSE','');
            const time = new Date().toLocaleTimeString();
            stockSymbolEl.textContent = currentSymbol;
            stockMetaEl.textContent = `NSE â€¢ Last updated: ${time}`;
            stockPriceEl.textContent = `â‚¹${price.toFixed(2)}`;

            // compute delta
            if(lastPrice !== null){
                const delta = price - lastPrice;
                const up = delta > 0;
                priceTrendEl.innerHTML = `${up ? 'â–²' : (delta<0? 'â–¼':'â€”')} ${Math.abs(delta).toFixed(2)}`;
                priceTrendEl.className = 'price-trend ' + (up? 'trend-up':'trend-down');
            }else{
                priceTrendEl.innerHTML = 'â€”';
                priceTrendEl.className = 'price-trend';
            }
            lastPrice = price;
            results.style.display = 'block';
            updateFavoriteButton();
        }

        // Popular and favorites
        async function initPopular(){
            try{
                const res = await fetch(`${API_BASE_URL}/stocks`);
                if(!res.ok) throw new Error('pop fetch failed');
                const data = await res.json();
                const list = data.stocks || [];
                popularEl.innerHTML = '';
                list.slice(0,8).forEach(s=>{
                    const row = document.createElement('div');
                    row.className = 'stock-quick-item';
                    row.innerHTML = `<div><strong>${s.symbol}</strong><div class="small">${s.name}</div></div><div><button class="favorite" title="Add to favorites">â˜†</button></div>`;
                    row.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()==='button') return; input.value = s.symbol; fetchStockPrice(s.symbol); });
                    const favBtn = row.querySelector('button');
                    favBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleFavorite(s.symbol); renderFavorites(); });
                    popularEl.appendChild(row);
                });
            }catch(e){ console.warn('popular init failed',e); }
        }

        function renderFavorites(){
            const favs = loadFavorites();
            favoritesEl.innerHTML = '';
            if(!favs.length) favoritesEl.innerHTML = '<div class="small">No favorites yet</div>';
            favs.forEach(sym=>{
                const row = document.createElement('div');
                row.className = 'stock-quick-item';
                row.innerHTML = `<div><strong>${sym}</strong></div><div><button class="favorite" title="Remove">âœ•</button></div>`;
                row.addEventListener('click', ()=>{ input.value = sym; fetchStockPrice(sym); });
                row.querySelector('button').addEventListener('click', (e)=>{ e.stopPropagation(); removeFavorite(sym); renderFavorites(); });
                favoritesEl.appendChild(row);
            });
        }

        function toggleFavorite(sym){
            const list = loadFavorites();
            if(list.includes(sym)){ removeFavorite(sym); }
            else { list.unshift(sym); saveFavorites(list.slice(0,30)); }
        }
        function removeFavorite(sym){ const list = loadFavorites().filter(s=>s!==sym); saveFavorites(list); }
        function updateFavoriteButton(){ const favs = loadFavorites(); favToggle.textContent = favs.includes(currentSymbol)? 'â˜… Favorited':'â˜† Favorite'; }

        // Actions
        searchBtn.addEventListener('click', ()=>{ if(input.value.trim()) fetchStockPrice(input.value.trim()); });
        clearBtn.addEventListener('click', ()=>{ input.value=''; results.style.display='none'; closeSuggestions(); clearError(); });
        favToggle.addEventListener('click', ()=>{ if(!currentSymbol) return; toggleFavorite(currentSymbol); renderFavorites(); updateFavoriteButton(); });
        refreshBtn.addEventListener('click', ()=>{ if(!currentSymbol) return; refreshBtn.disabled = true; refreshBtn.textContent = 'Refreshing...'; fetchStockPrice(currentSymbol).finally(()=>{ setTimeout(()=>{ refreshBtn.disabled=false; refreshBtn.textContent='âŸ³ Refresh'; }, 600); }); });

        // Auto refresh
        autoRefreshCheckbox.addEventListener('change', ()=>{
            if(autoRefreshCheckbox.checked){ if(currentSymbol) startAutoRefresh(); }
            else stopAutoRefresh();
        });

        function startAutoRefresh(){ stopAutoRefresh(); pollTimer = setInterval(()=>{ if(currentSymbol) fetchStockPrice(currentSymbol); }, AUTO_REFRESH_INTERVAL); }
        function stopAutoRefresh(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

        // Initialize
        (async function init(){
            initPopular();
            renderFavorites();
            clearError();
        })();

    </script>
</body>
</html>
